rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /* ================= HELPERS ================= */

    function isSignedIn() {
      return request.auth != null;
    }

    function userRole() {
      return isSignedIn()
        ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role
        : null;
    }

    function isAdmin() {
      return isSignedIn() && userRole() == "admin";
    }

    function isVet() {
      return isSignedIn() && userRole() == "veterinarian";
    }

    function isOwnerOrFarmer() {
      return isSignedIn() &&
        (userRole() == "owner" || userRole() == "farmer");
    }

    /* ================= USERS ================= */

    match /users/{userId} {
      allow read, create, update: if isSignedIn() && request.auth.uid == userId;
      allow delete: if isAdmin();
    }

    /* ================= VETERINARIANS ================= */

    match /veterinarians/{vetId} {

      // âœ… PUBLIC READ (FIXES YOUR ERROR)
      allow read: if true;

      // Vet creates their own profile
      allow create: if isVet()
        && request.auth.uid == request.resource.data.userId;

      // Vet edits own profile, admin edits any
      allow update: if
        (isVet() && request.auth.uid == resource.data.userId)
        || isAdmin();

      // Only admin deletes
      allow delete: if isAdmin();
    }

    /* ================= APPOINTMENTS ================= */

   match /appointments/{appointmentId} {

  // OWNER / FARMER: can read their own appointments
  allow read: if
    isOwnerOrFarmer() &&
    resource.data.userId == request.auth.uid;

  // VET: can read appointments assigned to them
  allow read: if
    isVet() &&
    resource.data.vetId == request.auth.uid;

  // ADMIN: unrestricted access
  allow read: if isAdmin();

  // CREATE
  allow create: if
    isOwnerOrFarmer() &&
    request.auth.uid == request.resource.data.userId &&
    request.resource.data.vetId is string;

  // UPDATE
  allow update: if
    isAdmin() ||
    (isVet() && request.auth.uid == resource.data.vetId) ||
    (isOwnerOrFarmer() && request.auth.uid == resource.data.userId);

  // DELETE
  allow delete: if isAdmin();
}

    /* ================= MESSAGES ================= */

    match /messages/{messageId} {

      allow read, create: if
        isSignedIn() &&
        (request.auth.uid == resource.data.senderId ||
         request.auth.uid == resource.data.receiverId) ||
        isAdmin();

      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /* ================= FALLBACK ================= */

    match /{document=**} {
      allow read, write: if isAdmin();
    }
  }
}
